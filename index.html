<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Breach: The Game</title>
  <style>
    body { display: flex; flex-direction: row; justify-content: center; gap: 30px; font-family: sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    .game-container { display: flex; flex-direction: column; max-width: 960px; }
    .controls button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    #timer { font-size: 18px; margin: 10px 0; }
    #game-area { position: relative; width: 960px; height: 540px; border: 1px solid #ccc; margin-bottom: 10px; }
    #background { width: 100%; height: 100%; }
    #character { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); height: 60%; pointer-events: none; }
    #options-box button { background: #fff; border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin: 5px auto; display: block; width: 100%; max-width: 400px; cursor: pointer; }
    #options-box button:hover { background: #f0f0f0; }
    #dialogue-box { background: rgba(255,255,255,0.95); padding: 20px; border:2px solid #444; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); font-size:16px; line-height:1.5; white-space: pre-wrap; min-height:100px; }
    .sidebar { min-width: 300px; }
    #score-box { font-size: 18px; margin-bottom: 10px; }
    #clue-sheet { border:1px solid #ccc; background:#fff; padding:10px; }
    #clue-sheet h3 { margin-top:0; }
    #clue-sheet ul { padding-left:20px; }
    #submit-report { margin-top:10px; padding:10px 20px; font-size:16px; width:100%; box-sizing:border-box; }
    .speaker-logan { color: #1f77b4; }
    .speaker-corey { color: #d62728; }
    .speaker-coyle { color: #2ca02c; }
    .speaker-reyes { color: #9467bd; }
    .speaker-crutchfield { color: #ff7f0e; }
    .speaker-you { color: #000; font-weight: bold; }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>The Breach: The Game</h1>
    <div id="timer">Time left: 30:00</div>
    <div class="controls">
      <button onclick="navigateTo('Lobby')">Lobby</button>
      <button onclick="navigateTo('Main Office')">Main Office</button>
      <button onclick="navigateTo('Break Room')">Break Room</button>
      <button onclick="navigateTo('HR Office')">HR Office</button>
      <button onclick="navigateTo('Server Room')">Server Room</button>
      <button onclick="navigateTo('Crutchfield\'s Office')">Crutchfield's Office</button>
    </div>
    <div id="game-area">
      <img id="background" src="" alt="Room">
      <img id="character" src="" alt="Character">
    </div>
    <div id="options-box"></div>
    <div id="dialogue-box"></div>
  </div>
  <div class="sidebar">
    <div id="score-box">Score: <span id="score-value">0</span></div>
    <div id="clue-sheet"><h3>Clue Sheet</h3><ul id="clue-list"></ul></div>
    <button id="submit-report" onclick="openFinalReport()">Submit Final Report</button>
  </div>
  <script>
    // Game state including score
    const state = {
      score: 0,
      clueSheet: [],
      coreyQuizDone: false,
      // dialogue trackers...
      loganDialogues:{}, coreyDialogues:{}, coyleDialogues:{}, reyesDialogues:{}, crutchfieldDialogues:{}
    };
    let currentRoom='', roomHtml={}, timeLeft=1800, timerInterval;

    function updateScore(amount) {
      state.score += amount;
      document.getElementById('score-value').innerText = state.score;
    }

    function formatLine(t) {
      return t.replace(/^([^:]+):/, (m,p1) => {
        const key = p1.toLowerCase().replace(/[^a-z]/g,'');
        return `<span class="speaker-${key}">${p1}:</span>`;
      });
    }

    function logDialogue(t) {
      const h = formatLine(t);
      if (!roomHtml[currentRoom]) roomHtml[currentRoom] = h;
      else roomHtml[currentRoom] += '<br>' + h;
      document.getElementById('dialogue-box').innerHTML = roomHtml[currentRoom];
    }

    function clearOptions() {
      document.getElementById('options-box').innerHTML = '';
    }

    function addOption(label, cb) {
      const b = document.createElement('button');
      b.textContent = label;
      b.onclick = () => {
        logDialogue('You: ' + label);
        cb();
      };
      document.getElementById('options-box').appendChild(b);
    }

    function addClue(c) {
      if (!state.clueSheet.includes(c)) {
        state.clueSheet.push(c);
        updateScore(20); // clue bonus
        const li = document.createElement('li');
        li.innerHTML = c.replace(/\b(?:Logan|Corey|Coyle|Reyes|Crutchfield)\b/g, m => `<span class="speaker-${m.toLowerCase()}">${m}</span>`);
        document.getElementById('clue-list').appendChild(li);
      }
    }

    function updateTimer() {
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        logDialogue('⏰ Time is up!');
        clearOptions();
        return;
      }
      const m = Math.floor(timeLeft/60), s = timeLeft%60;
      document.getElementById('timer').innerText = `Time left: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      timeLeft--;
    }

    function startTimer() {
      updateTimer(); timerInterval = setInterval(updateTimer,1000);
    }

    // Generic quiz engine
    function startQuiz({question, choices, onCorrect, onWrong}) {
      clearOptions();
      logDialogue(question);
      choices.forEach(({text, correct}) => {
        addOption(text, () => {
          if (correct) {
            updateScore(50); // correct quiz bonus
            onCorrect();
          } else {
            updateScore(-10); // penalty
            onWrong();
          }
        });
      });
    }

    function navigateTo(room) {
      currentRoom = room;
      highlightButtons(room);
      roomHtml[room] = '';
      document.getElementById('dialogue-box').innerHTML = '';
      clearOptions();
      // room visit bonus only first time
      if (!state.clueSheet.includes(`visited-${room}`)) {
        updateScore(10);
        state.clueSheet.push(`visited-${room}`);
      }
      // switch rooms (only HR Office shown here)
      switch (room) {
        case 'Lobby':
          document.getElementById('background').src = 'assets/rooms/lobby.png';
          document.getElementById('character').src = 'assets/characters/reyes.png';
          logDialogue("Reyes: 'There's been a security incident and we need your help. Navigate to the different rooms and talk with our agents — they may have clues about what happened. You have 30 minutes to solve this case! Good luck!'
");
          addOption('Start Investigation', () => {
            clearOptions();
            logDialogue("Reyes: 'Remember, check every room and gather as many clues as you can.'");
            addOption('Talk to Reyes', talkToReyes);
          });
          break;
        case 'HR Office':
          document.getElementById('background').src = 'assets/rooms/hr_office.png';
          document.getElementById('character').src = 'assets/characters/corey.png';
          logDialogue('Corey: "You find Corey at HR."');
          addOption('Talk to Corey', talkToCorey);
          break;
        // other cases...
      }
    }

    function talkToCorey() {
      clearOptions(); const d = state.coreyDialogues;
      if (!d.behavior) {
        logDialogue('Corey: "We had a spoof last quarter."');
        addOption('Ask about past incidents', () => {
          clearOptions(); logDialogue('Corey: "It was caught by Reyes in time."');
          addClue('Past spoof caught by Reyes.');
          d.behavior = true; talkToCorey();
        });
      }
      if (!state.coreyQuizDone) {
        addOption('Take Corey’s phishing quiz', () => startQuiz({
          question: 'Which part of this URL indicates a legitimate subdomain?',
          choices: [
            { text: 'secure-pay.bank.com', correct: false },
            { text: 'secure.payments.bank.com', correct: true },
            { text: 'bank_payments_secure.com', correct: false },
            { text: 'payments.secure-bank.com', correct: false }
          ],
          onCorrect: () => { logDialogue('Corey: "Exactly! That is the proper structure."'); addClue('Understood subdomain structure.'); talkToCorey(); },
          onWrong: () => { logDialogue('Corey: "Not quite. Watch hyphens vs dots."'); talkToCorey(); }
        }));
      }
      if (d.behavior && state.coreyQuizDone) {
        logDialogue('Corey: "Anything else?"');
        addOption('Talk again', talkToCorey);
      }
    }

    function openFinalReport() {
      clearOptions(); logDialogue('Submit final report: Who & how?');
      const container = document.getElementById('options-box');
      const cs = document.createElement('select'); cs.id='accusedCharacter';
      ['Logan','Corey','Coyle','Reyes','Crutchfield'].forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;cs.appendChild(o);}); container.appendChild(cs);
      const ss = document.createElement('select'); ss.id='breachScenario';
      ['Clicked a phishing email disguised as a new hire packet','Downloaded malware from USB drive','Reused credentials from past breach','Forwarded scam','Missed invoice scam','Ignored alert','Vishing call','Weak password','Malicious attachment','External access'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;ss.appendChild(o);}); container.appendChild(ss);
      const sb = document.createElement('button'); sb.textContent='Submit'; sb.onclick=()=>submitAccusation(cs.value,ss.value); container.appendChild(sb);
    }

    function submitAccusation(n,r) {
      clearOptions();
      if (n==='Logan'&&r==='Clicked a phishing email disguised as a new hire packet') {
        // time bonus
        const bonus = Math.floor(timeLeft/10);
        updateScore(bonus);
        logDialogue(`✅ Correct! Logan was the culprit. You earned a time bonus of ${bonus} points.`);
      } else {
        updateScore(-100);
        logDialogue(`❌ Not quite. ${n} & that method incorrect. -100 points penalty.`);
      }
    }

    function highlightButtons(room) {
      document.querySelectorAll('.controls button').forEach(b=>b.style.backgroundColor=b.textContent===room?'#d0eaff':'');
    }

    function startGame() { startTimer(); navigateTo('Lobby'); }
    document.addEventListener('DOMContentLoaded', startGame);
  </script>
</body>
</html>
